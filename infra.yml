---
- hosts: infra
  become: true
  become_user: root
  vars:
    #rhn_vars: /Volumes/Keybase/private/dlbewley/credz/redhat/vars.yml
    rhn_vars: /keybase/private/dlbewley/credz/redhat/vars.yml
    named_role: master
    packages:
      - bind-chroot
      - git
      - nfs-utils
      - squid
    firewall_services:
      - cockpit
      - http
      - squid
    
    # disable this slow step for now.
    # enable if /usr/share/syslniux changes
    pxe_copy_syslinux: false
    pxe_repo_http_server: 192.168.4.2

  pre_tasks:
    # $ nmcli con add type ethernet ifname ens224 con-name lab4 ipv4.addresses 192.168.4.2/24 ipv4.gateway 192.168.4.1 ipv4.method static
    # $ nmcli con add type ethernet ifname ens192 con-name lab5 ipv4.addresses 192.168.5.2/24 ipv4.gateway 192.168.5.1 ipv4.method static
    # - name: Include Network Setup
    #   include_tasks: tasks/network-nmcli.yml
    - name: Include Red Hat pre tasks
      include_tasks: tasks/RedHat-pre-tasks.yml
      when: ansible_os_family == 'RedHat'
      tags: [ registration ]

  roles:
     - role: RedHatInsights.insights-client
       when: ansible_os_family == 'RedHat'
       tags: [ registration ]

     - role: mrlesmithjr.squid
       when: '"proxy" in group_names'
       tags: [ proxy ]

     - role: dhcpd
       when: '"dhcpd" in group_names'
       tags: [ dhcpd ]

     - role: pxe
       when: '"pxe" in group_names'
       tags: [ pxe ]

    #  - role: named
    #    when: '"named" in group_names'
    #    tags: [ named ]

  tasks:
      - name: install packages
        yum:
          name: "{{ packages }}"
          state: present

      - name: setup proxy server
        import_tasks: tasks/proxy-server.yml
        when: '"proxy" in group_names'
        tags: [ proxy ]

      - name: open firewall
        firewalld:
          service: "{{ item }}"
          state: enabled
          permanent: yes
        loop: "{{ firewall_services }}"
        tags:
          - proxy
          - pxe