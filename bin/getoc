#!/bin/bash
# Download oc clients from mirror

VERSIONS="4.6 4.7 latest nightly"
#CLIENT_VERSIONS="4.4 4.5"
#INSTALLER_VERSIONS="4.4 4.5"
HELM_VERSIONS="latest"
INSTALL_DIR="$HOME/bin"
OC_BASE_URL=https://mirror.openshift.com/pub/openshift-v4/clients/

if [ $(uname) == "Darwin" ]; then
    PLATFORMS="macosx"
else
    PLATFORMS="linux"
fi

function download_helm() {
    version=$1
    platform=$2

    echo "Downloading helm for ${version}/${platform}"
    mkdir -p "helm-${version}/${platform}"
    pushd "helm-${version}/${platform}" > /dev/null
    plat=$(echo $platform | sed s/macosx/darwin/) # Darwin platform name is inconsistent on mirror
    curl -s -O ${OC_BASE_URL}/helm/${version}/helm-${plat}-amd64
    chmod 755 helm-${plat}-amd64
    ln -s helm-${plat}-amd64 helm
    popd > /dev/null
}

function download_client() {
    version=$1
    platform=$2

    echo "Downloading oc for ${version}/${platform}"
    # Darwin platform name is inconsistently applied on mirror
    if [ "$version" == "nightly" ]; then
        curl -s -o oc.tar.gz ${OC_BASE_URL}/ocp-dev-preview/latest/openshift-client-$(echo $platform | sed s/osx//).tar.gz
    else
        curl -s -O ${OC_BASE_URL}/oc/${version}/${platform}/oc.tar.gz
    fi
}

function download_installer() {
    version=$1
    platform=$2

    echo "Downloading installer for ${version}/${platform}"
    if [ "$version" == "nightly" ]; then
        curl -s -o openshift-install.tar.gz ${OC_BASE_URL}/ocp/latest-${version}/openshift-install-$(echo $platform | sed s/osx//).tar.gz;
        #curl -s -o openshift-install.tar.gz ${OC_BASE_URL}/ocp-dev-preview/latest-4.6/openshift-install-$(echo $platform | sed s/osx//).tar.gz
    fi
}

pushd $INSTALL_DIR > /dev/null
for version in $VERSIONS; do
    for platform in $PLATFORMS; do
        mkdir -p "oc-${version}/${platform}"
        pushd "oc-${version}/${platform}" > /dev/null

        download_client $version $platform
        download_installer $version $platform

        tar xzf oc.tar.gz
        tar xzf openshift-install.tar.gz
        popd > /dev/null
    done
done
for version in $HELM_VERSIONS; do
    for platform in $PLATFORMS; do
        download_helm $version $platform
    done
done
popd > /dev/null

